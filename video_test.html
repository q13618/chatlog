<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>视频播放测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .video-container { margin: 20px 0; }
        video { max-width: 100%; border: 1px solid #ccc; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>视频播放功能测试</h1>
    
    <div class="test-section">
        <h2>1. 基本视频播放测试</h2>
        <p>测试视频元素的基本功能：</p>
        <div class="video-container">
            <video id="testVideo" controls width="400">
                <source src="http://127.0.0.1:5030/video/test" type="video/mp4">
                您的浏览器不支持视频播放
            </video>
        </div>
        <div id="videoStatus" class="status info">等待测试...</div>
        <button onclick="testVideoPlayback()">测试视频播放</button>
        <button onclick="testVideoDecoding()">测试视频解码</button>
    </div>

    <div class="test-section">
        <h2>2. 自动播放测试</h2>
        <p>测试视频自动播放功能（注意：现代浏览器通常阻止自动播放）：</p>
        <div class="video-container">
            <video id="autoPlayVideo" width="400" muted>
                <source src="http://127.0.0.1:5030/video/test" type="video/mp4">
            </video>
        </div>
        <div id="autoPlayStatus" class="status info">等待测试...</div>
        <button onclick="testAutoPlay()">测试自动播放</button>
        <button onclick="testAutoPlayWithMuted()">测试静音自动播放</button>
    </div>

    <div class="test-section">
        <h2>3. 视频格式支持测试</h2>
        <p>测试不同视频格式的支持情况：</p>
        <div id="formatSupport" class="status info">检测中...</div>
        <button onclick="testFormatSupport()">检测格式支持</button>
    </div>

    <div class="test-section">
        <h2>4. 错误处理测试</h2>
        <p>测试视频加载失败时的错误处理：</p>
        <div class="video-container">
            <video id="errorVideo" controls width="400">
                <source src="http://127.0.0.1:5030/video/nonexistent" type="video/mp4">
            </video>
        </div>
        <div id="errorStatus" class="status info">等待测试...</div>
        <button onclick="testErrorHandling()">测试错误处理</button>
    </div>

    <div class="test-section">
        <h2>5. 性能测试</h2>
        <p>测试视频加载和播放性能：</p>
        <div id="performanceStatus" class="status info">等待测试...</div>
        <button onclick="testPerformance()">测试性能</button>
    </div>

    <div class="test-section">
        <h2>6. 测试日志</h2>
        <div id="testLog" class="log"></div>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <script>
        // 日志记录函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 清空日志
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // 测试基本视频播放
        function testVideoPlayback() {
            const video = document.getElementById('testVideo');
            const status = document.getElementById('videoStatus');
            
            log('开始测试基本视频播放功能');
            
            // 测试视频加载
            video.addEventListener('loadstart', () => {
                log('视频开始加载', 'success');
                status.textContent = '视频开始加载...';
                status.className = 'status info';
            });

            video.addEventListener('loadeddata', () => {
                log('视频数据加载完成', 'success');
                status.textContent = '视频数据加载完成';
                status.className = 'status success';
            });

            video.addEventListener('canplay', () => {
                log('视频可以开始播放', 'success');
                status.textContent = '视频可以开始播放';
                status.className = 'status success';
            });

            video.addEventListener('error', (e) => {
                log(`视频加载错误: ${e.message || '未知错误'}`, 'error');
                status.textContent = '视频加载失败';
                status.className = 'status error';
            });

            // 尝试播放
            video.play().then(() => {
                log('视频播放成功', 'success');
            }).catch(error => {
                log(`视频播放失败: ${error.message}`, 'error');
            });
        }

        // 测试视频解码
        function testVideoDecoding() {
            const video = document.getElementById('testVideo');
            const status = document.getElementById('videoStatus');
            
            log('开始测试视频解码功能');
            
            video.addEventListener('loadedmetadata', () => {
                const duration = video.duration;
                const width = video.videoWidth;
                const height = video.videoHeight;
                
                log(`视频元数据: 时长=${duration}s, 尺寸=${width}x${height}`, 'success');
                status.textContent = `解码成功: ${width}x${height}, 时长${duration}s`;
                status.className = 'status success';
            });

            video.addEventListener('error', (e) => {
                log(`解码错误: ${e.message || '未知错误'}`, 'error');
                status.textContent = '解码失败';
                status.className = 'status error';
            });
        }

        // 测试自动播放
        function testAutoPlay() {
            const video = document.getElementById('autoPlayVideo');
            const status = document.getElementById('autoPlayStatus');
            
            log('开始测试自动播放功能');
            
            video.play().then(() => {
                log('自动播放成功', 'success');
                status.textContent = '自动播放成功';
                status.className = 'status success';
            }).catch(error => {
                log(`自动播放失败: ${error.message}`, 'error');
                status.textContent = `自动播放失败: ${error.message}`;
                status.className = 'status error';
            });
        }

        // 测试静音自动播放
        function testAutoPlayWithMuted() {
            const video = document.getElementById('autoPlayVideo');
            const status = document.getElementById('autoPlayStatus');
            
            log('开始测试静音自动播放功能');
            video.muted = true;
            
            video.play().then(() => {
                log('静音自动播放成功', 'success');
                status.textContent = '静音自动播放成功';
                status.className = 'status success';
            }).catch(error => {
                log(`静音自动播放失败: ${error.message}`, 'error');
                status.textContent = `静音自动播放失败: ${error.message}`;
                status.className = 'status error';
            });
        }

        // 测试格式支持
        function testFormatSupport() {
            const status = document.getElementById('formatSupport');
            const video = document.createElement('video');
            
            log('开始检测视频格式支持');
            
            const formats = [
                { type: 'video/mp4', codec: 'avc1.42E01E' },
                { type: 'video/webm', codec: 'vp8' },
                { type: 'video/ogg', codec: 'theora' }
            ];
            
            let supportedFormats = [];
            
            formats.forEach(format => {
                if (video.canPlayType(`${format.type}; codecs="${format.codec}"`)) {
                    supportedFormats.push(format.type);
                    log(`支持格式: ${format.type}`, 'success');
                } else {
                    log(`不支持格式: ${format.type}`, 'error');
                }
            });
            
            if (supportedFormats.length > 0) {
                status.textContent = `支持的格式: ${supportedFormats.join(', ')}`;
                status.className = 'status success';
            } else {
                status.textContent = '没有支持的视频格式';
                status.className = 'status error';
            }
        }

        // 测试错误处理
        function testErrorHandling() {
            const video = document.getElementById('errorVideo');
            const status = document.getElementById('errorStatus');
            
            log('开始测试错误处理');
            
            video.addEventListener('error', (e) => {
                const error = video.error;
                let errorMessage = '未知错误';
                
                if (error) {
                    switch (error.code) {
                        case MediaError.MEDIA_ERR_ABORTED:
                            errorMessage = '用户中止';
                            break;
                        case MediaError.MEDIA_ERR_NETWORK:
                            errorMessage = '网络错误';
                            break;
                        case MediaError.MEDIA_ERR_DECODE:
                            errorMessage = '解码错误';
                            break;
                        case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            errorMessage = '不支持的格式';
                            break;
                    }
                }
                
                log(`错误处理测试: ${errorMessage}`, 'error');
                status.textContent = `错误: ${errorMessage}`;
                status.className = 'status error';
            });
        }

        // 测试性能
        function testPerformance() {
            const status = document.getElementById('performanceStatus');
            const video = document.getElementById('testVideo');
            
            log('开始测试视频性能');
            
            const startTime = performance.now();
            
            video.addEventListener('loadeddata', () => {
                const loadTime = performance.now() - startTime;
                log(`视频加载时间: ${loadTime.toFixed(2)}ms`, 'success');
                
                status.textContent = `加载时间: ${loadTime.toFixed(2)}ms`;
                status.className = 'status success';
            });
            
            video.addEventListener('error', () => {
                const loadTime = performance.now() - startTime;
                log(`加载失败时间: ${loadTime.toFixed(2)}ms`, 'error');
                
                status.textContent = `加载失败: ${loadTime.toFixed(2)}ms`;
                status.className = 'status error';
            });
        }

        // 页面加载完成后自动运行一些测试
        window.addEventListener('load', () => {
            log('页面加载完成，开始初始化测试');
            testFormatSupport();
        });
    </script>
</body>
</html>
